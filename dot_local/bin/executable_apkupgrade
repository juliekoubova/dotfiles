#!/bin/sh

: ${APKUPGRADE_NUM_SNAPS:=5}

if [ `id -u` != 0 ]; then
  echo must be root >&2
  exit 1
fi

ensure_command() {
  if ! command -v "$1" > /dev/null; then
    echo "$1 not found" >&2
    exit 1
  fi
}

ensure_command apk

upgradeable=`apk --update-cache list --upgradeable` || exit 1
upgradeable_count=`echo -n "${upgradeable}" | wc -l`

echo "${upgradeable_count} upgradeable package(s) found" >&2
echo "${upgradeable}" >&2
[ "${upgradeable_count}" -gt 0 ] || exit 0

root_dataset=`mount | grep ' on / type zfs' | awk '{print $1}'`

if [ -n "$root_dataset" ]; then
  ensure_command zfs-auto-snapshot
  zfs-auto-snapshot \
    --prefix apkupgrade \
    --event "${upgradeable}" \
    --keep "${APKUPGRADE_NUM_SNAPS}" \
    --verbose "$root_dataset" || exit 1
else
  echo "root is not ZFS, not making a snapshot" >&2
fi

echo "upgrading packages" >&2
exec apk upgrade 
